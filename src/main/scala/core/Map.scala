package core

// I <3 magic numbers!
// Tile types:
// 0: Empty
// 1: Wall (solid, visible)
// 2-5: Floor/ceiling textures
// 6: Door closed (solid, visible)
// 7: Door open (not solid, visible)
// 9: SpawnPoint (not solid, not visible)

class Map:
  val grid: Array[Array[Array[Int]]] = /// lvl, x, y  -- lvl 0: floor, lvl 1: walls, lvl 2: ceiling
    Array(
      Array( // Floor
        Array(12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12),
        Array(12, 5, 5, 5,12, 5, 5, 5, 5, 5,14, 5, 5,12, 5, 5, 5, 5, 5,12),
        Array(12,12, 5,12,12, 5,12, 5, 5,12, 5, 5, 5, 5, 5, 5, 5, 5, 5,12),
        Array(12, 2, 2, 2,12, 5,14, 5, 5, 5, 5,12, 5, 5, 5, 5, 5, 5, 5,12),
        Array(12, 2, 2, 2,12, 5, 5, 5,12, 5, 5, 5, 5, 5,12, 5,14, 5, 5,12),
        Array(12,12, 2,12,12,12, 5, 5, 5, 5, 5, 5,12, 5, 5, 5, 5, 5, 5,12),
        Array(12, 5, 5, 5, 5, 5,12, 5, 5, 5, 5, 5, 5, 5, 5, 5,12,12,12,12),
        Array(12, 5, 5, 5, 5, 5,12,12, 5,14, 5, 5, 5, 5, 5, 5, 5, 5, 5,12),
        Array(12, 5, 5,14, 5, 5, 5,12, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,12),
        Array(12, 5,14, 5, 5, 5, 5,12, 5, 5, 5, 5, 5,12,12,12, 5,12,12,12),
        Array(12, 5, 5, 5,12,12,12,12, 5, 5, 5, 5, 5,12,11,11,11,11,11,12),
        Array(12, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,14,12,11,11,11,11,11,12),
        Array(12, 5, 5, 5, 5, 5, 5, 5, 5, 5,14, 5, 5,12,11,11,11,11,11,12),
        Array(12,12,12,12,12,12,12,12,12,12, 5,12,12,12,12,12,12,11,12,12),
        Array(12,11,11,11,12,11,11,11,12, 5, 5, 5, 5,12, 5, 5, 5, 5, 5, 5),
        Array(12,11,11,11,12,11,11,11,12, 5, 5, 5, 5,12, 5, 3, 3, 3, 3, 5),
        Array(12,11,11,11,12,11,11,11,11, 5, 5, 5, 5,12, 5, 3, 3, 3, 3, 5),
        Array(12,11,11,11,12,12,12,12,12, 5, 5, 5, 5, 5, 5, 3, 3, 3, 3, 5),
        Array(12,11,11,11,11,11,11,11,11, 5, 5, 5, 5,12, 5, 3, 3, 3, 3, 5),
        Array(12,12,12,12,12,12,12,12,12,12,12,12,12,12, 5, 5, 5, 5, 5, 5),
      ),
      Array( // Walls
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 1, 8, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),
        Array(1, 9, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1),
        Array(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1),
        Array(1, 1, 6, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1),
        Array(1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1),
        Array(1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,10),
        Array(1, 0, 0, 0, 0, 0, 0,10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,10),
        Array(1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 6, 1, 1, 1),
        Array(1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 6, 1, 1, 1, 1, 1, 1, 6, 1, 1),
        Array(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,10),
        Array(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,10),
        Array(1, 0, 0, 0, 1, 0, 0, 0, 6, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,10),
        Array(1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0,10),
        Array(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,10),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,10,10,10,10,10,10),
      ),
      Array( // Ceiling
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
        Array(1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1),
        Array(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
      )
    )

  /// the open door 7 is not solid
  def isSolid(tileId: Int): Boolean = tileId match {
    case 0 | 9 | 7 => false
    case _ => true
  }

  def isVisible(tileId: Int): Boolean = tileId match {
    case 0 | 9 => false
    case _ => true
  }

  def notSolid(x: Double, y: Double, lvl: Int): Boolean = {
    val tileId = grid(lvl)(y.toInt)(x.toInt)
    !isSolid(tileId)
  }

  def isOpaque(tileId: Int): Boolean = tileId match {
    case 7 | 8 | 10 => false
    case _ => isVisible(tileId)
  }

  def isSpawnable(x: Int, y: Int): Boolean = {
    // Spawneri voidaa laittaa vaa sellaseen paikkaan missÃ¤ lattia on 5 ja sen viereset lattiat on 5
    val id = grid(0)(y)(x)
    if (id != 5 && id != 11 && id != 14) return false

    val directions = List(
      (0, 1),
      (1, 1),
      (1, 0),
      (1, -1),
      (0, -1),
      (-1, -1),
      (-1, 0),
      (-1, 1)
    )

    directions.forall { case (dx, dy) =>
      val neighborX = x + dx
      val neighborY = y + dy
      val neighborId = grid(0)(neighborY)(neighborX)
      neighborId == 5 || neighborId == 11
    }
  }

  def updateMap(x: Double, y: Double, changeTo: Int, lvl: Int = 1): Unit = {
    grid(lvl)(y.toInt)(x.toInt) = changeTo
  }

  val spawnPos: (Double, Double) = {
    val posOption = for {
      (row, i) <- grid(1).zipWithIndex
      (value, j) <- row.zipWithIndex
      if value == 9
    } yield (i + 0.5, j + 0.5)
    posOption.headOption.getOrElse((5.5, 5.5))
  }

  val size = grid(1).length
